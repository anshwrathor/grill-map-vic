<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grill Map Victoria — BBQ Access</title>

<!-- Vega -->
<script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f7fb; --surface:#ffffff; --ink:#0e1326; --muted:#6a728c; --line:#e8ecf5;
  --accent:#ff7a59; --accent-2:#ff9b6a;
  --chip-bg:rgba(18,22,40,.06); --chip-fg:#2b355b; --chip-bd:#e3e7f3;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0c1020; --surface:#141a2f; --ink:#eef1ff; --muted:#aeb4c9; --line:#202a49;
    --accent:#ff8b66; --accent-2:#ffa77f;
    --chip-bg:rgba(255,255,255,.05); --chip-fg:#cfd6ff; --chip-bd:#2a3764;
  }
}
*{box-sizing:border-box}
html,body{height:100%}
html{scroll-behavior:smooth}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}

/* Header (non-sticky for no overlap) */
header{
  background:
    linear-gradient(180deg, rgba(255,255,255,.9) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%),
    radial-gradient(1200px 300px at 50% -80px, rgba(255,122,89,.12), transparent 60%);
  border-bottom:1px solid var(--line);
}
.header-inner{max-width:1120px;margin:0 auto;padding:28px 20px 18px}
h1{margin:0;font-size:2.35rem;font-weight:800;letter-spacing:-.2px;color:#111322}
.badge{
  display:inline-block;margin-left:.5rem;background:var(--accent);color:#fff;
  padding:4px 10px;border-radius:6px;font-weight:600;font-size:.8rem;letter-spacing:.3px;
}
.subtitle{color:#444b63;opacity:.9;margin-top:6px}

/* Header subnav links: make them high-contrast pills */
.header-inner .subtitle a{
  display:inline-block;
  font-weight:700;
  color: var(--ink);                 /* text color */
  background: var(--chip-bg);        /* pill bg */
  border: 1px solid var(--chip-bd);  /* subtle outline */
  padding: 6px 10px;
  border-radius: 10px;
  text-decoration:none;
  transition: background .15s ease, color .15s ease, border-color .15s ease, transform .05s ease;
}

/* spacing between the pills */
.header-inner .subtitle a + a{ margin-left:8px }

/* Hover / active */
.header-inner .subtitle a:hover{
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
  color:#fff;
  border-color: transparent;
}
.header-inner .subtitle a:active{ transform: translateY(1px) }

/* Keyboard focus ring */
.header-inner .subtitle a:focus-visible{
  outline: 2px solid var(--accent);
  outline-offset: 2px;
  border-color: transparent;
}

/* Controls */
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:12px}
.control{
  display:inline-flex;align-items:center;gap:10px;background:var(--surface);
  border:1px solid var(--line);padding:10px 12px;border-radius:14px;box-shadow:0 4px 14px rgba(15,18,32,.05);
}
.control input[type="search"], .control select{border:none;outline:none;background:transparent;color:var(--ink);font:inherit}
.status{background:var(--chip-bg);color:var(--chip-fg);border:1px solid var(--chip-bd);border-radius:12px;padding:8px 12px;font-weight:600}
button.reset{
  border:none;background:linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);color:#fff;border-radius:12px;
  padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 8px 22px rgba(255,122,89,.25);
  transition:transform .1s ease, filter .15s ease;
}
button.reset:hover{filter:brightness(1.05)} button.reset:active{transform:translateY(1px)}

/* Layout / Cards */
main{max-width:1120px;margin:22px auto;padding:16px;display:flex;flex-direction:column;gap:18px}
.card{
  background:var(--surface);border:1px solid var(--line);border-radius:18px;
  padding:20px 20px 24px;box-shadow:0 16px 40px rgba(15,18,32,.08);
}
.grid{display:grid;gap:20px}
@media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
h2{margin:0 0 8px;font-size:1.15rem;font-weight:800}
.lede{margin:0 0 10px;color:var(--muted)}
.vis{width:100%;min-height:300px;border-radius:14px;outline:1px solid var(--line);overflow:hidden}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
.kpi{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:14px 16px}
.kpi h3{margin:0;color:var(--muted);font-size:.9rem;font-weight:600}
.kpi p{margin:6px 0 0;font-size:1.55rem;font-weight:800}

/* ===== Side-by-side clusters (chart + side info) ===== */
.cluster{
  display:grid;
  grid-template-columns: 1.25fr .75fr; /* chart | info */
  gap:20px; align-items:start; margin-bottom:18px;
}
.info{ padding:18px 18px 20px }
.info h3{ margin:0 0 8px; font-size:1.05rem; font-weight:800 }
.info p{ margin:6px 0 0; color:var(--muted) }
.info ul{ margin:8px 0 0 18px; line-height:1.6; color:var(--muted) }
.sticky{ position:sticky; top:88px }

/* Mobile: stack */
@media (max-width: 980px){
  .cluster{ grid-template-columns: 1fr }
  .sticky{ position:static }
}

/* Footer */
footer{max-width:1120px;margin:16px auto 44px;padding:0 16px;color:var(--muted);text-align:center}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <h1>Grill Map Victoria <small class="badge">Prototype</small></h1>
    <p class="subtitle">Fairness in public BBQ access across Victorian councils</p>
    <div class="controls">
      <span class="control">Metric:
        <select id="metric">
          <option value="per10k" selected>BBQs per 10k</option>
          <option value="bbq_count">Total BBQs</option>
        </select>
      </span>
      <span class="control">Top-N:
        <select id="topn">
          <option value="0" selected>All</option>
          <option value="5">Top 5</option>
          <option value="10">Top 10</option>
          <option value="20">Top 20</option>
        </select>
      </span>
      <span class="control">Search:
        <input id="search" type="search" placeholder="Type a council…" spellcheck="false" />
      </span>
      <button class="reset" id="resetBtn" title="Clear highlights">Reset</button>
      <span id="status" class="status">Loading…</span>
    </div>

    <p class="subtitle">
      <a href="#map">Map</a> ·
      <a href="#bars">Ranking</a> ·
      <a href="#hist">Distribution</a> ·
      <a href="#box">Metro vs Regional</a>
    </p>

    <div class="kpis">
      <div class="kpi"><h3>Total BBQs</h3><p id="kpi-total">—</p></div>
      <div class="kpi"><h3>Avg per 10k</h3><p id="kpi-per10k">—</p></div>
      <div class="kpi"><h3>LGAs</h3><p id="kpi-lgas">—</p></div>
    </div>
  </div>
</header>

<main>
  <!-- ROW 1: Map + side notes -->
  <section class="cluster">
    <div class="card">
      <h2>Where are BBQs most accessible?</h2>
      <div id="map" class="vis" style="height:460px"></div>
    </div>

    <aside class="card info sticky">
      <h3>How to read this</h3>
      <ul>
        <li><strong>Bubble size</strong> = total BBQs; <strong>color</strong> = per-capita access.</li>
        <li>Use the <em>Metric</em> switch to flip between totals and per-10k.</li>
        <li>Search highlights a council; Top-N focuses the view.</li>
      </ul>
      <h3 style="margin-top:14px">What stands out</h3>
      <ul>
        <li><strong>Per-capita flips the story.</strong> Big totals don’t always mean good access.</li>
        <li><strong>Regional pockets</strong> often show higher access per person.</li>
      </ul>
    </aside>
  </section>

  <!-- ROW 2: Bars + side notes -->
  <section class="cluster">
    <div class="card">
      <h2>Councils ranked by the selected metric</h2>
      <div id="bars" class="vis" style="height:460px"></div>
    </div>

    <aside class="card info sticky">
      <h3>Why this ranking?</h3>
      <p>The bar chart sorts councils by the active metric. Add an average line to spotlight below-typical access.</p>
      <h3 style="margin-top:14px">Tips</h3>
      <ul>
        <li>Switch to <strong>Top-10</strong> to de-clutter and compare leaders.</li>
        <li>Toggle to <strong>Total BBQs</strong> to show scale effects.</li>
      </ul>
    </aside>
  </section>

  <!-- ROW 3: Histogram + side notes -->
  <section class="cluster">
    <div class="card">
      <h2>Distribution of access</h2>
      <div id="hist" class="vis" style="height:360px"></div>
    </div>

    <aside class="card info sticky">
      <h3>What this shows</h3>
      <p>How many LGAs fall into each per-capita access band. The orange rule marks the statewide average.</p>
      <ul>
        <li>Right-skew suggests a few leaders with much higher access.</li>
        <li>Use it to justify Top-N or priority bands.</li>
      </ul>
    </aside>
  </section>

  <!-- ROW 4: Boxplot + side notes -->
  <section class="cluster">
    <div class="card">
      <h2>Metro vs Regional</h2>
      <div id="box" class="vis" style="height:360px"></div>
    </div>

    <aside class="card info sticky">
      <h3>Comparing groups</h3>
      <p>Boxplots compare the distribution of per-capita access across Metro and Regional councils.</p>
      <ul>
        <li>Jittered points show each LGA; use tooltips to inspect.</li>
        <li>Swap in your real metro/regional flag when ready.</li>
      </ul>
    </aside>
  </section>

  <!-- Optional compact overview -->
  <section class="cluster">
    <div class="card">
      <h2>Project overview</h2>
      <p class="lede">
        This dashboard compares public barbecue access across Victorian councils (LGAs).
        We report <strong>total BBQs</strong> and <strong>BBQs per 10,000 residents</strong>.
      </p>
    </div>

    <aside class="card info">
      <h3>Data & method</h3>
      <p>
        BBQ locations: Data.Vic (Public Barbecues, 2023).<br/>
        Population: ABS LGA, 2023.<br/>
        <strong>BBQs per 10k</strong> = BBQ count ÷ (population / 10,000).
      </p>
    </aside>
  </section>
</main>

<footer>
 

   <p>
    Sources: Public BBQ Facilities (Data.Vic, 2023) · ABS Population by LGA (2023)<br/>
    Built with Vega-Lite · FIT3179 Data Visualisation 2<br/>
    <strong>Author:</strong> Ansh Rathore &nbsp; | &nbsp;
    <strong>Date:</strong> 20 October 2025<br/>
    Monash University · School of Information Technology
  </p>
</footer>

<script>
/* ---------------- Paths ---------------- */
const CSV_PATH = "data/bbq_by_lga_demo.csv";

/* ---------------- Fallback data ---------------- */
const FALLBACK = [
  {"lga":"Melbourne","lat":-37.81,"lon":144.96,"population":150000,"bbq_count":7,"per10k":0.4667},
  {"lga":"Port Phillip","lat":-37.84,"lon":144.96,"population":114000,"bbq_count":10,"per10k":0.8772},
  {"lga":"Geelong","lat":-38.15,"lon":144.36,"population":270000,"bbq_count":11,"per10k":0.4074},
  {"lga":"Ballarat","lat":-37.56,"lon":143.85,"population":116000,"bbq_count":16,"per10k":1.3793},
  {"lga":"Bendigo","lat":-36.76,"lon":144.28,"population":123000,"bbq_count":11,"per10k":0.8943},
  {"lga":"Mornington Peninsula","lat":-38.34,"lon":145.04,"population":171000,"bbq_count":9,"per10k":0.5263}
];

/* ---------------- State ---------------- */
let ALL_ROWS = [];
let currentMetric = "per10k";  // 'per10k' | 'bbq_count'
let currentTopN   = 0;
let currentQuery  = "";

/* ---------------- DOM refs ---------------- */
const metricSel = document.getElementById("metric");
const topnSel   = document.getElementById("topn");
const searchInp = document.getElementById("search");
const resetBtn  = document.getElementById("resetBtn");
const statusEl  = document.getElementById("status");

/* ---------------- Utils ---------------- */
function parseCSV(txt){
  const lines = txt.trim().split(/\r?\n/);
  const hdrs  = lines[0].split(",").map(h=>h.trim());
  return lines.slice(1).filter(Boolean).map(line=>{
    const cells = line.split(",").map(c=>c.trim());
    const o = {}; hdrs.forEach((h,i)=>o[h]=cells[i]);
    ["lat","lon","population","bbq_count","per10k"].forEach(k=>{
      if (o[k] !== undefined && o[k] !== null && o[k] !== "") o[k] = Number(o[k]);
    });
    return o;
  });
}
const sum  = (a,f=x=>x)=>a.reduce((s,d)=>s+f(d),0);
const mean = (a,f=x=>x)=>a.length?sum(a,f)/a.length:0;
const fmt  = n => Number.isFinite(n)? n.toLocaleString() : "—";

/* ---------------- KPIs ---------------- */
function updateKPIs(rows){
  document.getElementById("kpi-total").textContent  = fmt(sum(rows,d=>+d.bbq_count||0));
  document.getElementById("kpi-per10k").textContent = (mean(rows,d=>+d.per10k||0)).toFixed(2);
  document.getElementById("kpi-lgas").textContent   = rows.length;
}

/* ---------------- Filtering ---------------- */
function getFilteredRows(){
  let rows = [...ALL_ROWS];
  if (currentQuery){
    const q = currentQuery.toLowerCase();
    rows = rows.filter(d => (d.lga||"").toLowerCase().includes(q));
  }
  const field = (currentMetric==="bbq_count") ? "bbq_count" : "per10k";
  rows.sort((a,b)=> (+b[field]||0) - (+a[field]||0));
  if (currentTopN>0) rows = rows.slice(0,currentTopN);
  return rows;
}

function computeProjectionFromData(rows) {
  const lats = rows.map(d => +d.lat).filter(Number.isFinite);
  const lons = rows.map(d => +d.lon).filter(Number.isFinite);
  if (!lats.length || !lons.length) return { center:[145.2,-37.6], scale:3800 };

  const minLat = Math.min(...lats), maxLat = Math.max(...lats);
  const minLon = Math.min(...lons), maxLon = Math.max(...lons);
  const center = [ (minLon+maxLon)/2, (minLat+maxLat)/2 ];

  const mapEl = document.getElementById('map');
  const W = (mapEl?.clientWidth  || 720) * 0.90;
  const H = (mapEl?.clientHeight || 460) * 0.90;

  const lonSpan = Math.max(0.05, maxLon - minLon);
  const scaleX  = (W) / (lonSpan * (Math.PI/180));

  const toMy = (φdeg) => Math.log(Math.tan(Math.PI/4 + (φdeg*Math.PI/180)/2));
  const ySpan = Math.max(1e-6, Math.abs(toMy(maxLat) - toMy(minLat)));
  const scaleY = H / ySpan;

  const scale = Math.min(scaleX, scaleY);
  return { center, scale };
}

// ---------------- MAP (fully self-contained; no external files) ----------------
function mapBubbleSpec(values){
  const field = (currentMetric === "bbq_count") ? "bbq_count" : "per10k";
  const title = (field === "bbq_count") ? "Total BBQs" : "BBQs per 10k";

  // Use your computed projection, but with a safe fallback & clamp
  const p = computeProjectionFromData(values) || { center: [133, -27], scale: 1200 };
  const center = Array.isArray(p.center) ? p.center : [133, -27];
  const scale  = Math.max(600, Math.min(5000, (p.scale || 1200) * 0.95));

  return {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": "container",
    "height": 460,
    "projection": { "type": "mercator", "center": center, "scale": scale },

    "layer": [
      /* --- Australia land (from local GeoJSON) --- */
      {
        "data": {
          "url": "assets/ne_admin_0_countries.geojson",
          "format": { "type": "geojson" }
        },
        "transform": [{
          /* handle ADMIN vs admin; normalize case; avoid undefined */
          "filter": "lower(((datum.properties && (datum.properties.ADMIN || datum.properties.admin)) || '')) == 'australia'"
        }],
        "mark": { "type": "geoshape", "fill": "#22304a", "fillOpacity": 0.85, "stroke": "#37517a", "strokeWidth": 0.8 }
      },

      /* --- Australia state borders (local GeoJSON) --- */
      {
        "data": {
          "url": "assets/ne_admin_1_states_provinces.geojson",
          "format": { "type": "geojson" }
        },
        "transform": [{
          "filter": "lower(((datum.properties && datum.properties.admin) || '')) == 'australia'"
        }],
        "mark": { "type": "geoshape", "fill": null, "stroke": "#9fbaff", "strokeWidth": 1.3 }
      },

      /* --- Victoria highlight (local GeoJSON) --- */
      {
        "data": {
          "url": "assets/ne_admin_1_states_provinces.geojson",
          "format": { "type": "geojson" }
        },
        "transform": [{
          "filter":
            "(lower(((datum.properties && datum.properties.admin) || '')) == 'australia') && " +
            "(lower((((datum.properties && (datum.properties.name || datum.properties.name_en)) || ''))) == 'victoria')"
        }],
        "mark": { "type": "geoshape", "fill": null, "stroke": "#e6ecff", "strokeWidth": 2.2 }
      },

      /* --- Your BBQ bubbles (on top) --- */
      {
        "data": { "values": values },
        "transform": [
          { "calculate": "toNumber(datum.lat)", "as": "_lat" },
          { "calculate": "toNumber(datum.lon)", "as": "_lon" },
          { "filter": "isFinite(datum._lat) && isFinite(datum._lon)" }
        ],
        "mark": { "type": "circle", "stroke": "#0b1220", "strokeWidth": 0.8, "opacity": 0.95 },
        "encoding": {
          "latitude":  { "field": "_lat", "type": "quantitative" },
          "longitude": { "field": "_lon", "type": "quantitative" },
          "size":      {
            "field": "bbq_count",
            "type": "quantitative",
            "title": "Total BBQs",
            "scale": { "range": [60, 900] }
          },
          "color":     {
            "field": field,
            "type": "quantitative",
            "title": title,
            "scale": { "scheme": "tealblues" }
          },
          "tooltip": [
            { "field": "lga", "title": "Council" },
            { "field": "bbq_count", "title": "Total BBQs" },
            { "field": "per10k", "title": "BBQs per 10k", "format": ".2f" },
            { "field": "population", "title": "Population", "format": "," }
          ]
        }
      }
    ],

    "config": {
  "view": { "stroke": null },
  "background": null,
  "legend": {
    "labelColor": "#e6ebff",      // legend numbers
    "titleColor": "#f8f9ff",      // legend titles
    "labelFontSize": 12,
    "titleFontSize": 13,
    "labelFontWeight": "500"
  },
  "axis": {
    "labelColor": "#e6ebff",
    "titleColor": "#f8f9ff"
  }
}
  };
}
/* ---------------- BARS ---------------- */
function barsSpec(values){
  const field = (currentMetric==="bbq_count") ? "bbq_count" : "per10k";
  const title = (field==="per10k") ? "BBQs per 10,000 residents" : "Total BBQs";
  const arr   = [...values].sort((a,b)=> (+b[field]||0) - (+a[field]||0));

  return {
    "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
    "width":"container","height":460,"padding":10,"data":{"values":arr},
    "layer":[
      /* 1) Bars */
      {
        "mark":{"type":"bar","cornerRadiusEnd":8},
        "encoding":{
          "y":{
            "field":"lga","type":"nominal",
            "sort":{"field":field,"order":"descending"},   // keep sort consistent
            "title":null,"axis":{"labelLimit":180}
          },
          "x":{"field":field,"type":"quantitative","title":title,"axis":{"grid":true,"tickCount":5}},
          "color":{"value":"#ff7a59"},
          "tooltip":[
            {"field":"lga"},
            {"field":"bbq_count","title":"Total BBQs"},
            {"field":"per10k","title":"BBQs per 10k","format":".2f"},
            {"field":"population","title":"Population","format":","}
          ]
        }
      },

      /* 2) Value labels at the end of each bar */
      {
        "mark":{"type":"text","align":"left","dx":6,"fontSize":11,"fontWeight":700,"color":"#0e1326"},
        "encoding":{
          "y":{
            "field":"lga","type":"nominal",
            "sort":{"field":field,"order":"descending"}   // same sort => no Vega warning
          },
          "x":{"field":field,"type":"quantitative"},
          "text":{"field":field,"type":"quantitative","format": (field==='per10k'?'.2f':',d')}
        }
      },

      /* 3) Inline annotations (← add THIS block) */
      {
        "data": { "values": [
          {"lga": "Ballarat",  "note": "↑ Highest per-capita access"},
          {"lga": "Melbourne", "note": "Large population, lower per-capita"}
        ]},
        // Optional: bring the metric into this layer so Vega can keep the same y-scale order
        "transform": [
          {"lookup": "lga", "from": {"data":{"values":arr}, "key":"lga", "fields":[field]}}
        ],
        "mark": {"type":"text", "align":"left", "dx":8, "dy":-4, "fontSize":11, "fontWeight":600, "color":"#555"},
        "encoding": {
          "y": {"field":"lga","type":"nominal"},        // uses shared y-scale from layer 1
          "x": {"datum": 0},                            // anchor at the left edge (x=0)
          "text": {"field":"note"}
        }
      }
    ],
    "config":{"view":{"stroke":"#dde3f1","cornerRadius":14}}
  };
}

/* ---------------- HIST ---------------- */
function histSpec(values){
  const avg = values.length ? values.reduce((s,d)=>s+(+d.per10k||0),0)/values.length : 0;
  return {
    "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
    "width":"container","height":360,
    "data":{"values": values},
    "layer":[
      {
        "mark":{"type":"bar","cornerRadiusEnd":6},
        "encoding":{
          "x":{"bin":{"maxbins":8}, "field":"per10k", "type":"quantitative", "title":"BBQs per 10k"},
          "y":{"aggregate":"count", "type":"quantitative", "title":"LGAs"},
          "color":{"value":"#5ac8fa"}
        }
      },
      {
        "mark":{"type":"rule","stroke":"#ff7a59","strokeWidth":2},
        "encoding":{"x":{"datum":avg,"type":"quantitative"}}
      },
      {
        "mark":{"type":"text","dy":-8,"fontSize":11,"fontWeight":600,"color":"#ff7a59"},
        "encoding":{"x":{"datum":avg,"type":"quantitative"},"y":{"value":10},"text":{"datum":"Avg"}}
      }
    ],
    "config":{"view":{"stroke":"#dde3f1","cornerRadius":12}}
  };
}

/* ---------------- BOX ---------------- */
function boxSpec(values){
  const metroSet = new Set(["Melbourne","Port Phillip","Geelong"]); // temp grouping
  const data = values.map(d => ({...d, group: metroSet.has(d.lga) ? "Metro" : "Regional"}));

  return {
    "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
    "width":"container","height":360,
    "data":{"values": data},
    "layer":[
      {
        "mark":{"type":"boxplot","extent":"min-max"},
        "encoding":{
          "x":{"field":"group","type":"nominal","title":null},
          "y":{"field":"per10k","type":"quantitative","title":"BBQs per 10k"},
          "color":{"field":"group","type":"nominal","legend":null}
        }
      },
      {
        "mark":{"type":"point","filled":true,"opacity":0.85,"size":120,"stroke":"#0e1326","strokeWidth":0.5},
        "transform":[
          {"calculate":"datum.group === 'Metro' ? -0.15 : 0.15","as":"jx"}
        ],
        "encoding":{
          "x":{"field":"group","type":"nominal","title":null, "axis":null},
          "y":{"field":"per10k","type":"quantitative"},
          "xOffset":{"field":"jx"},
          "color":{"field":"group","type":"nominal","legend":null},
          "tooltip":[{"field":"lga"},{"field":"per10k","format":".2f"}]
        }
      }
    ],
    "config":{"view":{"stroke":"#dde3f1","cornerRadius":12}}
  };
}

/* ---------------- Render ---------------- */
function renderAll(){
  let rows = getFilteredRows();
  if (!rows || rows.length === 0) rows = [...FALLBACK];   // <<< safety net
  updateKPIs(rows);
  vegaEmbed("#map",  mapBubbleSpec(rows), {actions:false}).catch(console.error);
  vegaEmbed("#bars", barsSpec(rows),     {actions:false}).catch(console.error);
  vegaEmbed("#hist", histSpec(rows),     {actions:false}).catch(console.error);
  vegaEmbed("#box",  boxSpec(rows),      {actions:false}).catch(console.error);
}

/* ---------------- Controls ---------------- */
metricSel.addEventListener("change", ()=>{ currentMetric = metricSel.value; renderAll(); });
topnSel  .addEventListener("change", ()=>{ currentTopN   = +topnSel.value;   renderAll(); });
let t=null;
searchInp.addEventListener("input", ()=>{
  clearTimeout(t);
  t=setTimeout(()=>{ currentQuery = searchInp.value.trim(); renderAll(); }, 140);
});
resetBtn.addEventListener("click", ()=>{
  currentMetric="per10k"; currentTopN=0; currentQuery="";
  metricSel.value="per10k"; topnSel.value="0"; searchInp.value="";
  renderAll();
});

/* ---------------- Init ---------------- */
(async function init(){
  ALL_ROWS = FALLBACK;
  statusEl.textContent = "Demo data loaded (will swap if CSV loads)…";
  renderAll();

  try{
    if (location.protocol === "file:") {
      statusEl.textContent = "Opened via file:// — demo mode. Start a local server to load CSV.";
      return;
    }
    const res = await fetch(CSV_PATH, {cache:"no-store"});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt  = await res.text();
    const rows = parseCSV(txt);
    if (!rows.length) throw new Error("CSV parsed but 0 rows");
    ALL_ROWS = rows;
    statusEl.style.opacity = "0"; setTimeout(()=>statusEl.style.display="none",300);
    renderAll();
  }catch(err){
    console.warn("Using demo data - CSV load failed:", err);
    statusEl.textContent = `Using demo data (couldn't load ${CSV_PATH})`;
  }
})();
</script>
</body>
</html>